<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Week02</title>
  <style>
      .cell {
          line-height: 7px;
          width: 6px;
          height: 6px;
          vertical-align: top;
          border: 1px grey solid;
          box-sizing: border-box;
      }

      .container {
          width: 600px;
          display: flex;
          flex-wrap: wrap;
      }

  </style>
</head>
<body>
<div class="container" id="container"></div>
<button id="btn">Save</button>
<script>
  // config
  const SIZE = 100
  const CELL_TYPE = {
    WALK: 2,
    WALL: 1,
    GROUND: 0,
  }
  const map = localStorage["map"] ? JSON.parse(localStorage["map"]) : Array(SIZE * SIZE).fill(CELL_TYPE.GROUND)

  // helper
  function getElement(id) {
    return document.getElementById(id)
  }

  const getIndex = (function (size) {
    return function (x, y) {
      return y * size + x
    }
  })(100)

  // 寫死 map 陣列
  function getCellType(x, y) {
    return map[getIndex(x, y)]
  }

  function sleep(delay) {
    return new Promise(resolve => {
      setTimeout(resolve, delay)
    })
  }

  const saveBtn = getElement("btn")
  const container = getElement("container")

  // 編輯器操作狀態
  let isMouseDown = false
  document.addEventListener("mouseup", () => {
    isMouseDown = false
  })

  let isClear = false
  document.addEventListener("mousedown", e => {
    isMouseDown = true
    isClear = e.which === 3
  })
  document.addEventListener("contextmenu", e => {
    e.preventDefault()
  })

  function initMap() {
    for (let y = 0; y < SIZE; y++) {
      for (let x = 0; x < SIZE; x++) {
        const cell = document.createElement("div")
        cell.classList.add("cell")

        if (map[getIndex(x, y)] === CELL_TYPE.WALL) {
          cell.style.backgroundColor = "black"
        } else if (map[getIndex(x, y)] === CELL_TYPE.GROUND) {
          cell.style.backgroundColor = "white"
        }

        cell.addEventListener("mousemove", () => {
          if (isMouseDown) {
            const index=getIndex(x,y)
            if (isClear) {
              map[index]=CELL_TYPE.GROUND
              cell.style.backgroundColor = "white"
            } else {
              map[index]=CELL_TYPE.WALL
              cell.style.backgroundColor = "black"
            }
          }
        })

        container.appendChild(cell)
      }
    }
  }

  async function path(map, start, end) {
    const queue = [start]

    async function insert(x, y) {
      if (x < 0 || x >= 100 || y < 0 || y >= 100) return
      const index = getIndex(x, y)
      if (map[index] === CELL_TYPE.GROUND) {
        map[index] = CELL_TYPE.WALK
        container.children[index].style.backgroundColor = "lightgreen"
        queue.push([x, y])
        await sleep(10)
      }
    }

    while (queue.length) {
      const [x, y] = queue.shift()
      // console.log(x, y);
      if (x === end[0] && y === end[1]) return true
      await insert(x - 1, y)
      await insert(x + 1, y)
      await insert(x, y - 1)
      await insert(x, y + 1)
    }
    return false
  }

  initMap()
</script>
</body>
</html>